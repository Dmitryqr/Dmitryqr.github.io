# drone_web_app.py - –í–°–Å –í –û–î–ù–û–ú –§–ê–ô–õ–ï
from flask import Flask, render_template, request, jsonify, send_from_directory
import json
import os
import uuid
from datetime import datetime

app = Flask(__name__)

# –ü–∞–ø–∫–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
os.makedirs('data/routes', exist_ok=True)
os.makedirs('data/missions', exist_ok=True)

class RouteManager:
    def __init__(self):
        self.routes_file = 'data/routes/saved_routes.json'
        self.load_routes()
    
    def load_routes(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
        if os.path.exists(self.routes_file):
            with open(self.routes_file, 'r', encoding='utf-8') as f:
                self.routes = json.load(f)
        else:
            self.routes = {}
    
    def save_routes(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
        with open(self.routes_file, 'w', encoding='utf-8') as f:
            json.dump(self.routes, f, ensure_ascii=False, indent=2)
    
    def create_route(self, name, points, altitude=50, speed=10):
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞"""
        route_id = str(uuid.uuid4())
        route = {
            'id': route_id,
            'name': name,
            'points': points,
            'altitude': altitude,
            'speed': speed,
            'created_at': datetime.now().isoformat(),
            'total_distance': self.calculate_distance(points)
        }
        
        self.routes[route_id] = route
        self.save_routes()
        return route
    
    def get_route(self, route_id):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ ID"""
        return self.routes.get(route_id)
    
    def get_all_routes(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
        return list(self.routes.values())
    
    def delete_route(self, route_id):
        """–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞"""
        if route_id in self.routes:
            del self.routes[route_id]
            self.save_routes()
            return True
        return False
    
    def calculate_distance(self, points):
        """–†–∞—Å—á–µ—Ç –æ–±—â–µ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞"""
        if len(points) < 2:
            return 0
        
        total = 0
        for i in range(len(points)-1):
            p1 = points[i]
            p2 = points[i+1]
            # –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–≤ –º–µ—Ç—Ä–∞—Ö)
            dist = ((p2['lat'] - p1['lat'])**2 + (p2['lng'] - p1['lng'])**2)**0.5 * 111000
            total += dist
        
        return round(total, 2)

class DroneSimulator:
    def __init__(self):
        self.current_mission = None
    
    def execute_mission(self, route):
        """–°–∏–º—É–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏—Å—Å–∏–∏"""
        mission_id = str(uuid.uuid4())
        mission = {
            'id': mission_id,
            'route_id': route['id'],
            'route_name': route['name'],
            'status': 'completed',
            'started_at': datetime.now().isoformat(),
            'completed_at': datetime.now().isoformat(),
            'total_points': len(route['points']),
            'total_distance': route['total_distance']
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏—Å—Å–∏—é
        mission_file = f"data/missions/{mission_id}.json"
        with open(mission_file, 'w', encoding='utf-8') as f:
            json.dump(mission, f, ensure_ascii=False, indent=2)
        
        return mission

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
route_manager = RouteManager()
drone_simulator = DroneSimulator()

# HTML —à–∞–±–ª–æ–Ω
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Route Planner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .map-container {
            flex: 1;
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
        .route-list {
            margin-top: 20px;
        }
        .route-item {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .route-name {
            font-weight: bold;
            color: #333;
        }
        .route-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .coordinates-display {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <h1>üéØ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥—Ä–æ–Ω–∞</h1>
            
            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ -->
            <div class="form-group">
                <label for="routeName">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞:</label>
                <input type="text" id="routeName" placeholder="–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∫–∞">
            </div>
            
            <div class="form-group">
                <label for="altitude">–í—ã—Å–æ—Ç–∞ –ø–æ–ª–µ—Ç–∞ (–º):</label>
                <input type="number" id="altitude" value="50" min="10" max="200">
            </div>
            
            <div class="form-group">
                <label for="speed">–°–∫–æ—Ä–æ—Å—Ç—å (–º/—Å):</label>
                <input type="number" id="speed" value="10" min="1" max="20">
            </div>
            
            <button onclick="startDrawing()">üéØ –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</button>
            <button onclick="clearRoute()" class="secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            <button onclick="saveRoute()" class="secondary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
            <div class="coordinates-display" id="coordinates">
                –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ -->
            <div class="route-list">
                <h3>üìÅ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã:</h3>
                <div id="routesList"></div>
            </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let routePoints = [];
        let polyline = null;
        let isDrawing = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 13); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
            loadRoutes();
        }

        // –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function startDrawing() {
            isDrawing = true;
            routePoints = [];
            if (polyline) {
                map.removeLayer(polyline);
            }
            updateCoordinatesDisplay();
            alert('üó∫Ô∏è –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - –∑–∞–≤–µ—Ä—à–∏—Ç—å.');
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–æ–≤
        map.on('click', function(e) {
            if (!isDrawing) return;
            
            routePoints.push({
                lat: e.latlng.lat,
                lng: e.latlng.lng
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞
            if (polyline) {
                map.removeLayer(polyline);
            }
            
            if (routePoints.length > 1) {
                polyline = L.polyline(routePoints, {color: 'blue'}).addTo(map);
            }
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
            L.marker(e.latlng).addTo(map)
                .bindPopup(`–¢–æ—á–∫–∞ ${routePoints.length}`)
                .openPopup();
            
            updateCoordinatesDisplay();
        });

        // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
        map.on('dblclick', function() {
            if (isDrawing && routePoints.length > 1) {
                isDrawing = false;
                alert(`‚úÖ –ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –¢–æ—á–µ–∫: ${routePoints.length}`);
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function updateCoordinatesDisplay() {
            const coordsDiv = document.getElementById('coordinates');
            coordsDiv.innerHTML = routePoints.map((point, index) => 
                `${index + 1}. ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}`
            ).join('<br>') || '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...';
        }

        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞
        function clearRoute() {
            routePoints = [];
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            updateCoordinatesDisplay();
            isDrawing = false;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function saveRoute() {
            const name = document.getElementById('routeName').value;
            const altitude = parseInt(document.getElementById('altitude').value);
            const speed = parseInt(document.getElementById('speed').value);
            
            if (!name) {
                alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞!');
                return;
            }
            
            if (routePoints.length < 2) {
                alert('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã 2 —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É!');
                return;
            }
            
            fetch('/api/routes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    points: routePoints,
                    altitude: altitude,
                    speed: speed
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('‚úÖ –ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                loadRoutes();
                clearRoute();
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
        function loadRoutes() {
            fetch('/api/routes')
                .then(response => response.json())
                .then(routes => {
                    const routesList = document.getElementById('routesList');
                    routesList.innerHTML = '';
                    
                    routes.forEach(route => {
                        const routeDiv = document.createElement('div');
                        routeDiv.className = 'route-item';
                        routeDiv.innerHTML = `
                            <div class="route-name">${route.name}</div>
                            <div class="route-info">
                                –¢–æ—á–µ–∫: ${route.points.length} | 
                                –î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${route.total_distance}–º |
                                –í—ã—Å–æ—Ç–∞: ${route.altitude}–º
                            </div>
                            <button onclick="loadRoute('${route.id}')" class="secondary">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                            <button onclick="executeMission('${route.id}')">üöÄ –í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                            <button onclick="deleteRoute('${route.id}')" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        `;
                        routesList.appendChild(routeDiv);
                    });
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É
        function loadRoute(routeId) {
            fetch(`/api/routes/${routeId}`)
                .then(response => response.json())
                .then(route => {
                    clearRoute();
                    routePoints = route.points;
                    
                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
                    if (routePoints.length > 1) {
                        polyline = L.polyline(routePoints, {color: 'green'}).addTo(map);
                        map.fitBounds(polyline.getBounds());
                    }
                    
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
                    routePoints.forEach((point, index) => {
                        L.marker([point.lat, point.lng]).addTo(map)
                            .bindPopup(`–¢–æ—á–∫–∞ ${index + 1}`);
                    });
                    
                    updateCoordinatesDisplay();
                    document.getElementById('routeName').value = route.name;
                    document.getElementById('altitude').value = route.altitude;
                    document.getElementById('speed').value = route.speed;
                });
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏—Å—Å–∏–∏
        function executeMission(routeId) {
            if (!confirm('üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏—Å—Å–∏—é —Å —ç—Ç–∏–º –º–∞—Ä—à—Ä—É—Ç–æ–º?')) return;
            
            fetch(`/api/missions/execute`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({route_id: routeId})
            })
            .then(response => response.json())
            .then(mission => {
                alert(`‚úÖ –ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!\\n–¢–æ—á–µ–∫: ${mission.total_points}\\n–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${mission.total_distance}–º`);
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏—Å—Å–∏–∏: ' + error);
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        function deleteRoute(routeId) {
            if (!confirm('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç?')) return;
            
            fetch(`/api/routes/${routeId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('‚úÖ –ú–∞—Ä—à—Ä—É—Ç —É–¥–∞–ª–µ–Ω!');
                        loadRoutes();
                    }
                });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
'''

# API –º–∞—Ä—à—Ä—É—Ç—ã
@app.route('/')
def index():
    return HTML_TEMPLATE

@app.route('/api/routes', methods=['GET'])
def get_routes():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã"""
    return jsonify(route_manager.get_all_routes())

@app.route('/api/routes', methods=['POST'])
def create_route():
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç"""
    data = request.json
    route = route_manager.create_route(
        name=data['name'],
        points=data['points'],
        altitude=data.get('altitude', 50),
        speed=data.get('speed', 10)
    )
    return jsonify(route)

@app.route('/api/routes/<route_id>', methods=['GET'])
def get_route(route_id):
    """–ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –ø–æ ID"""
    route = route_manager.get_route(route_id)
    if route:
        return jsonify(route)
    return jsonify({'error': '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

@app.route('/api/routes/<route_id>', methods=['DELETE'])
def delete_route(route_id):
    """–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"""
    if route_manager.delete_route(route_id):
        return jsonify({'success': True})
    return jsonify({'error': '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

@app.route('/api/missions/execute', methods=['POST'])
def execute_mission():
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏—Å—Å–∏—é"""
    data = request.json
    route = route_manager.get_route(data['route_id'])
    
    if not route:
        return jsonify({'error': '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
    
    mission = drone_simulator.execute_mission(route)
    return jsonify(mission)

if __name__ == '__main__':
    print("üöÄ –ó–∞–ø—É—Å–∫ Drone Route Planner...")
    print("üì° –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000")
    print("üó∫Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ")
    app.run(debug=True, host='0.0.0.0', port=5000)
    </script>
</body>
</html>
